commit 6342b3032954fdf00cc5b236bae8698a82c1b583
Author: Yang Bo <yangbo@deepin.com>
Date:   Sat Jan 13 12:40:21 2018 +0800

    x86/kprobe: preempt counter unblanced
    
    Signed-off-by: Yang Bo <yangbo@deepin.com>

diff --git a/arch/x86/kernel/kprobes/core.c b/arch/x86/kernel/kprobes/core.c
index b55d07b9d..2f582111a 100644
--- a/arch/x86/kernel/kprobes/core.c
+++ b/arch/x86/kernel/kprobes/core.c
@@ -559,6 +559,9 @@ static void setup_singlestep(struct kprobe *p, struct pt_regs *regs,
 		regs->ip = (unsigned long)p->addr;
 	else
 		regs->ip = (unsigned long)p->ainsn.insn;
+#ifdef CONFIG_PREEMPT
+       preempt_enable_no_resched();
+#endif
 }
 NOKPROBE_SYMBOL(setup_singlestep);
 
